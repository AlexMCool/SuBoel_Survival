##############################################################################
#                          factory item delay init                           #
##############################################################################
factory_item_delay_init:
  command: /factory_item_delay_init
  type: RUN_CONSOLE
  register: true
  runcmd:
  # arg1 = (factory_id)
  # arg2 = (factory_owner)
  # arg3 = (factory_level)
  # arg4 = (item_name)
  # arg5 = (damage_value)
  
  # calculate how many hours
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.hours=1'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.hours+$arg3'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.hours-$s.product.minimum_level.$arg4:$arg5'
  # calculate how many items/hour
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.hours*$s.product.multiplier.$arg4:$arg5'
  # calculate how many ticks/item
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation=72000'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation/$PlayerDataFor%$arg2%$s.init.product.hours%'
  
  # round answer
  # reset rounded
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded=0'
  # round answer via binary search
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=131072'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+131072'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-131072'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=65536'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+65536'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-65536'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=32768'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+32768'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-32768'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=16384'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+16384'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-16384'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=8192'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+8192'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-8192'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=4096'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+4096'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-4096'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=2048'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+2048'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-2048'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=1024'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+1024'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-1024'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=512'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+512'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-512'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=256'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+256'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-256'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=128'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+128'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-128'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=64'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+64'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-64'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=32'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+32'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-32'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=16'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+16'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-16'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=8'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+8'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-8'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=4'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+4'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-4'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=2'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+2'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-2'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=1'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+1'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-1'
  - '$Script$%if%$PlayerDataFor%$arg2%$s.init.product.operation%>=0.5'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.rounded+1'
  - '$Script$%PlayerDataFor%$arg2%$s.init.product.operation-0.5'
  
  # set factory's item delay variable to rounded number (if the number isn't the max number, which means the dividing has failed)
  - '$Script$%if%always==always<and>$PlayerDataFor%$arg2%$s.init.product.rounded%!=262144'
  - '$Script$%Variable%$s.factory.id.$arg1.product.delay=$PlayerDataFor%$arg2%$s.init.product.rounded%'
  # set up scoreboard scores
  - '/minecraft:scoreboard players set @e[name=sfItemDelay,tag=sfID$arg1,type=area_effect_cloud] sfDelayVar $s.factory.id.$arg1.product.delay'
  - '/minecraft:scoreboard players set @e[name=sfItemDelay,tag=sfID$arg1,type=area_effect_cloud] sfItemDelay $s.factory.id.$arg1.product.delay'
  
  # set factory's item delay variable to rounded number (if the number is the max number, which means the dividing has failed)
  - '$Script$%if%always==always<and>$PlayerDataFor%$arg2%$s.init.product.rounded%>=262144'
  - '$Script$%Variable%$s.factory.id.$arg1.product.delay=none'
  # set up scoreboard scores
  - '/minecraft:scoreboard players reset @e[name=sfItemDelay,tag=sfID$arg1,type=area_effect_cloud] sfDelayVar'
  - '/minecraft:scoreboard players reset @e[name=sfItemDelay,tag=sfID$arg1,type=area_effect_cloud] sfItemDelay'
  
  
  
  
  
##############################################################################
#                         factory item delay player                          #
##############################################################################
factory_item_delay_player:
  command: /factory_item_delay_player
  type: RUN_CONSOLE
  register: true
  runcmd:
  # manage factory item delay timers
  - '/mycommand:factory_item_delay_timer $player $uuid'
  
  
  
  
  
##############################################################################
#                          factory item delay timer                          #
##############################################################################
factory_item_delay_timer:
  command: /factory_item_delay_timer
  type: RUN_CONSOLE
  register: true
  runcmd:
  # arg1 = (name)
  # arg2 = (uuid)
  
  # if timer is disabled
  - '$Script$%elseif%$PlayerDataFor%$arg1%$s.init.product.timer%==disabled'
  # add to active_ticks
  - '$Script$%PlayerDataFor%$arg1%$s.init.activity.active_ticks+1'
  # add to week_active_ticks
  - '$Script$%PlayerDataFor%$arg1%$s.init.activity.week_active_ticks+1'
  # add loan
  - '/minecraft:scoreboard players add @a[name=$arg1,score_saLoan=0,score_saLoan_min=0] ssCoins $s.general.loan'
  # "[Loan] You received ßx for being active for an hour"
  - '/minecraft:tellraw @a[name=$arg1,score_saLoan=0,score_saLoan_min=0] [{"bold":"true","color":"$s.style.color.mark","text":"["},{"bold":"false","color":"$s.style.color.title","text":"Loan"},{"bold":"true","color":"$s.style.color.mark","text":"]"},{"bold":"false","color":"$s.style.color.normal","text":" You received"},{"bold":"false","color":"$s.style.color.mark","text":" ß$s.general.loan"},{"bold":"false","color":"$s.style.color.normal","text":" for being active for an hour"}]'
  # reset loan delay
  - '/minecraft:scoreboard players set @a[name=$arg1,score_saLoan=0] saLoan 72000'
  # remove from loan delay
  - '/minecraft:scoreboard players remove $arg1 saLoan 1'
  # remove from cooldown
  - '/minecraft:scoreboard players remove $arg1 saCooldown 1'
  # remove from timer area_effect_clouds
  - '/minecraft:scoreboard players remove @e[name=sfItemDelay,tag=sf$arg2,type=area_effect_cloud] sfItemDelay 1'
  
  # if timer is enabled
  - '$Script$%elseif%$PlayerDataFor%$arg1%$s.init.product.timer%!=disabled'
  # add to active_ticks
  - '$Script$%PlayerDataFor%$arg1%$s.init.activity.active_ticks+1'
  # add to week_active_ticks
  - '$Script$%PlayerDataFor%$arg1%$s.init.activity.week_active_ticks+1'
  # add loan
  - '/minecraft:scoreboard players add @a[name=$arg1,score_saLoan=0,score_saLoan_min=0] ssCoins $s.general.loan'
  # "[Loan] You received ßx for being active for an hour"
  - '/minecraft:tellraw @a[name=$arg1,score_saLoan=0,score_saLoan_min=0] [{"bold":"true","color":"$s.style.color.mark","text":"["},{"bold":"false","color":"$s.style.color.title","text":"Loan"},{"bold":"true","color":"$s.style.color.mark","text":"]"},{"bold":"false","color":"$s.style.color.normal","text":" You received"},{"bold":"false","color":"$s.style.color.mark","text":" ß$s.general.loan"},{"bold":"false","color":"$s.style.color.normal","text":" for being active for an hour"}]'
  # reset loan delay
  - '/minecraft:scoreboard players set @a[name=$arg1,score_saLoan=0] saLoan 72000'
  # remove from loan delay
  - '/minecraft:scoreboard players remove $arg1 saLoan 1'
  # remove from cooldown
  - '/minecraft:scoreboard players remove $arg1 saCooldown 1'
  # remove from timer area_effect_clouds
  - '/minecraft:scoreboard players remove @e[name=sfItemDelay,tag=sf$arg2,type=area_effect_cloud] sfItemDelay 1'
  #  check each player's factory ID
  - '/minecraft:execute @e[c=1,name=sfItemDelay,score_sfItemDelay=0,tag=sf$arg2,type=area_effect_cloud] ~ ~ ~ /mycommand:factory_item_delay_check_init $arg1 $arg2 1 2'
  
  
  
  
  
##############################################################################
#                       factory item delay check init                        #
##############################################################################
factory_item_delay_check_init:
  command: /factory_item_delay_check_init
  type: RUN_CONSOLE
  delaytimer: 1
  delaytimer_format: TICKS
  register: true
  runcmd:
  # arg1 = (name)
  # arg2 = (uuid)
  # arg3 = (player_factory_id)
  # arg4 = (next_id)
  
  # disable timer
  - '$Script$%PlayerDataFor%$arg1%$s.init.product.timer=disabled'
  
  # if (next_id) is not the last id
  - '$Script$%elseif%$PlayerDataFor%$arg1%$s.factory.factory_id.$arg3.id%!=NoData<and>$PlayerDataFor%$arg1%$s.factory.factory_id.$arg4.id%!=NoData'
  # spawn item and reset timer
  - '/minecraft:execute @e[c=1,name=sfItemDelay,score_sfItemDelay=0,tag=sf$arg2,type=area_effect_cloud] ~ ~ ~ /mycommand:factory_item_delay_check $arg1 $arg2 $PlayerDataFor%$arg1%$s.factory.factory_id.$arg3.id%'
  # recur
  - '/minecraft:execute @e[c=1,name=sfItemDelay,tag=sf$arg2,type=area_effect_cloud] ~ ~ ~ /mycommand:factory_item_delay_check_recur $arg1 $arg2 $arg3 $arg4'
  
  # if (next_id) is last id
  - '$Script$%elseif%$PlayerDataFor%$arg1%$s.factory.factory_id.$arg3.id%!=NoData<and>$PlayerDataFor%$arg1%$s.factory.factory_id.$arg4.id%==NoData'
  # spawn item and reset timer
  - '/minecraft:execute @e[c=1,name=sfItemDelay,score_sfItemDelay=0,tag=sf$arg2,type=area_effect_cloud] ~ ~ ~ /mycommand:factory_item_delay_check $arg1 $arg2 $PlayerDataFor%$arg1%$s.factory.factory_id.$arg3.id%'
  # enable timer
  - '$Script$%PlayerDataFor%$arg1%$s.init.product.timer=enabled'
  
  
  
  
  
##############################################################################
#                       factory item delay check recur                       #
##############################################################################
factory_item_delay_check_recur:
  command: /factory_item_delay_check_recur
  type: RUN_CONSOLE
  delaytimer: 1
  delaytimer_format: TICKS
  register: true
  runcmd:
  # arg1 = (name)
  # arg2 = (uuid)
  # arg3 = (player_factory_id)
  # arg4 = (next_id)
  
  # add 1 to (player_factory_id) and (next_id)
  - '$Script$%PlayerDataFor%$arg1%$s.init.product.temp_id=$arg3'
  - '$Script$%PlayerDataFor%$arg1%$s.init.product.temp_id+1'
  - '$Script$%PlayerDataFor%$arg1%$s.init.product.next_id=$arg4'
  - '$Script$%PlayerDataFor%$arg1%$s.init.product.next_id+1'
  
  # retry
  - '$delay$/mycommand:factory_item_delay_check_init $arg1 $arg2 $PlayerDataFor%$arg1%$s.init.product.temp_id% $PlayerDataFor%$arg1%$s.init.product.next_id%'
  
  
  
  
  
##############################################################################
#                          factory item delay check                          #
##############################################################################
factory_item_delay_check:
  command: /factory_item_delay_check
  type: RUN_CONSOLE
  register: true
  runcmd:
  # arg1 = (name)
  # arg2 = (uuid)
  # arg3 = (factory_id)
  
  # spawn item (blockdata)
  - '/minecraft:execute @e[c=1,name=sfItemDelay,score_sfItemDelay=0,tag=sfID$arg3,type=area_effect_cloud] ~ ~ ~ /mycommand:factory_item_spawn $arg3'
  
  # reset timer
  - '/minecraft:execute @e[c=1,name=sfItemDelay,score_sfItemDelay=0,tag=sfID$arg3,type=area_effect_cloud] ~ ~ ~ /minecraft:function suboel:factory/items/variable'
